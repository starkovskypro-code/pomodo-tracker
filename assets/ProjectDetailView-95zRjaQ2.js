import{_ as M,e as y,b as f,o as k,a as e,i as _,w as V,m as C,z as J,f as N,g as K,A as ce,h as x,B as me,d as B,t as R,C as L,l as j,F as Q,p as ve,c as W,D as U,E as A,G as O,H as ke,I as X,J as Y,K as Z,L as ee,j as pe,v as fe,M as _e,n as ye,y as we,u as Te,s as ge,N as be}from"./index-BNaTmjPP.js";import{B as D}from"./BaseButton-CDRO35Af.js";import{a as te,P as he,B as q}from"./ProjectForm-o_S-585B.js";import{C as H}from"./ConfirmDialog-BRGDetR_.js";import{T as Ce}from"./Timer-DwU7MS5A.js";import{c as je,f as $e,a as ae,b as G,u as Ve,d as Se}from"./projectRepository-CTpxSQ9r.js";const Be={class:"task-form__row"},xe={__name:"TaskForm",emits:["submit"],setup(c,{emit:v}){const s=v,a=y(""),l=y("");function d(){l.value="";const w=a.value.trim();if(!w){l.value="Введите название задачи";return}s("submit",w),a.value=""}return(w,i)=>(k(),f("form",{class:"task-form",onSubmit:J(d,["prevent"])},[e("div",Be,[_(te,{modelValue:a.value,"onUpdate:modelValue":i[0]||(i[0]=g=>a.value=g),placeholder:"Новая задача...",error:l.value},null,8,["modelValue","error"]),_(D,{variant:"primary",type:"submit",disabled:!a.value.trim()},{default:V(()=>[...i[1]||(i[1]=[C(" Добавить ",-1)])]),_:1},8,["disabled"])])],32))}},Re=M(xe,[["__scopeId","data-v-bb968898"]]),De={class:"task-card__left"},Me={key:0,class:"task-card__restored-badge",title:"Восстановленная задача"},Ee={class:"task-card__name"},Ie={class:"task-card__right"},Pe={class:"task-card__stats"},Ne={class:"task-card__cost"},Le={class:"task-card__menu-wrapper"},Ue={key:0,class:"task-card__dropdown"},Ae=["aria-label","disabled"],Oe={key:0,width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor"},Fe={key:1,width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor"},ze={__name:"TaskCard",props:{task:{type:Object,required:!0},hourlyRate:{type:Number,default:0},activeTaskId:{type:Number,default:null},isTimerRunning:{type:Boolean,default:!1},elapsedSeconds:{type:Number,default:0}},emits:["start-timer","stop-timer","edit","delete","complete","restore"],setup(c,{expose:v,emit:s}){const a=c,l=s,d=y(!1),w=y(0),i=N(()=>a.activeTaskId===a.task.id),g=N(()=>i.value&&a.isTimerRunning?w.value+a.elapsedSeconds:w.value),b=N(()=>je(g.value,a.hourlyRate));K(async()=>{await r(),document.addEventListener("click",m)}),ce(()=>{document.removeEventListener("click",m)}),x(()=>a.task.id,async()=>{await r()}),x(()=>a.isTimerRunning,async(h,p)=>{p===!0&&h===!1&&await r()}),x(()=>a.activeTaskId,async(h,p)=>{p===a.task.id&&h!==a.task.id&&await r()});async function r(){try{w.value=await me(a.task.id)}catch(h){console.error("Ошибка загрузки времени задачи:",h)}}function o(h){h.stopPropagation(),d.value=!d.value}function t(){d.value=!1}function m(h){d.value&&t()}function S(){i.value?l("stop-timer"):l("start-timer",a.task.id)}function T(){t(),l("edit",a.task)}function E(){t(),l("complete",a.task.id)}function I(){t(),l("restore",a.task)}function P(){t(),l("delete",a.task.id)}return v({loadTime:r}),(h,p)=>(k(),f("div",{class:L(["task-card",{"task-card--completed":c.task.completed,"task-card--active":i.value}])},[e("div",De,[c.task.isRestored?(k(),f("span",Me," ↩ ")):B("",!0),e("span",Ee,R(c.task.name),1)]),e("div",Ie,[e("div",Pe,[e("span",{class:L(["task-card__time",{"task-card__time--active":i.value}])},R(j($e)(g.value)),3),e("span",Ne,R(j(ae)(b.value)),1)]),e("div",Le,[e("button",{class:"task-card__menu-btn",onClick:o,"aria-label":"Меню действий"},[...p[0]||(p[0]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor"},[e("circle",{cx:"12",cy:"5",r:"2"}),e("circle",{cx:"12",cy:"12",r:"2"}),e("circle",{cx:"12",cy:"19",r:"2"})],-1)])]),d.value?(k(),f("div",Ue,[e("button",{class:"task-card__dropdown-item",onClick:T},[...p[1]||(p[1]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),e("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})],-1),C(" Редактировать ",-1)])]),c.task.completed?(k(),f("button",{key:1,class:"task-card__dropdown-item",onClick:I},[...p[3]||(p[3]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("polyline",{points:"1,4 1,10 7,10"}),e("path",{d:"M3.51 15a9 9 0 1 0 2.13-9.36L1 10"})],-1),C(" Восстановить ",-1)])])):(k(),f("button",{key:0,class:"task-card__dropdown-item",onClick:E},[...p[2]||(p[2]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("polyline",{points:"20,6 9,17 4,12"})],-1),C(" Завершить ",-1)])])),e("button",{class:"task-card__dropdown-item task-card__dropdown-item--danger",onClick:P},[...p[4]||(p[4]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("polyline",{points:"3,6 5,6 21,6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})],-1),C(" Удалить ",-1)])])])):B("",!0)]),c.task.completed?B("",!0):(k(),f("button",{key:0,class:L(["task-card__timer-btn",{"task-card__timer-btn--active":i.value}]),onClick:S,"aria-label":i.value?"Остановить таймер":"Запустить таймер",disabled:c.isTimerRunning&&!i.value},[i.value?(k(),f("svg",Oe,[...p[5]||(p[5]=[e("rect",{x:"6",y:"6",width:"12",height:"12",rx:"2"},null,-1)])])):(k(),f("svg",Fe,[...p[6]||(p[6]=[e("polygon",{points:"5,3 19,12 5,21"},null,-1)])]))],10,Ae))]),d.value?(k(),f("div",{key:0,class:"task-card__overlay",onClick:t})):B("",!0)],2))}},qe=M(ze,[["__scopeId","data-v-019568c9"]]),He={class:"task-list"},Ge={key:0,class:"task-list__empty"},Je={key:1,class:"task-list__items"},Ke={__name:"TaskList",props:{tasks:{type:Array,required:!0},hourlyRate:{type:Number,default:0},activeTaskId:{type:Number,default:null},isTimerRunning:{type:Boolean,default:!1},elapsedSeconds:{type:Number,default:0}},emits:["start-timer","stop-timer","edit","delete","complete","restore"],setup(c){return(v,s)=>(k(),f("div",He,[c.tasks.length===0?(k(),f("div",Ge,[...s[6]||(s[6]=[e("p",null,"Пока нет задач",-1),e("p",{class:"task-list__empty-hint"},"Добавьте первую задачу выше",-1)])])):(k(),f("div",Je,[(k(!0),f(Q,null,ve(c.tasks,a=>(k(),W(qe,{key:a.id,task:a,"hourly-rate":c.hourlyRate,"active-task-id":c.activeTaskId,"is-timer-running":c.isTimerRunning,"elapsed-seconds":c.elapsedSeconds,onStartTimer:s[0]||(s[0]=l=>v.$emit("start-timer",l)),onStopTimer:s[1]||(s[1]=l=>v.$emit("stop-timer")),onEdit:s[2]||(s[2]=l=>v.$emit("edit",l)),onDelete:s[3]||(s[3]=l=>v.$emit("delete",l)),onComplete:s[4]||(s[4]=l=>v.$emit("complete",l)),onRestore:s[5]||(s[5]=l=>v.$emit("restore",l))},null,8,["task","hourly-rate","active-task-id","is-timer-running","elapsed-seconds"]))),128))]))]))}},Qe=M(Ke,[["__scopeId","data-v-8bdf9431"]]),We={class:"task-edit-form__time-section"},Xe={class:"task-edit-form__time-inputs"},Ye={class:"task-edit-form__time-field"},Ze={class:"task-edit-form__time-field"},et={class:"task-edit-form__time-field"},tt={class:"task-edit-form__actions"},at={__name:"TaskEditForm",props:{task:{type:Object,required:!0}},emits:["submit","cancel"],setup(c,{emit:v}){const s=c,a=v,l=U({name:""}),d=U({hours:"",minutes:"",seconds:""}),w=U({name:""}),i=y(!1);x(()=>s.task,o=>{o&&(l.name=o.name||"")},{immediate:!0});function g(){let o=!0;return w.name="",l.name.trim()||(w.name="Укажите название задачи",o=!1),o}function b(){const o=parseInt(d.hours)||0,t=parseInt(d.minutes)||0,m=parseInt(d.seconds)||0;return o*3600+t*60+m}async function r(){g()&&(i.value=!0,a("submit",{name:l.name.trim(),additionalSeconds:b()}),i.value=!1)}return(o,t)=>(k(),f("form",{class:"task-edit-form",onSubmit:J(r,["prevent"])},[_(te,{modelValue:l.name,"onUpdate:modelValue":t[0]||(t[0]=m=>l.name=m),label:"Название задачи",placeholder:"Название...",error:w.name},null,8,["modelValue","error"]),e("div",We,[t[8]||(t[8]=e("label",{class:"task-edit-form__label"},"Добавить время вручную",-1)),t[9]||(t[9]=e("p",{class:"task-edit-form__hint"}," Укажите часы, минуты и секунды, которые нужно добавить ",-1)),e("div",Xe,[e("div",Ye,[A(e("input",{"onUpdate:modelValue":t[1]||(t[1]=m=>d.hours=m),type:"number",min:"0",placeholder:"0",class:"task-edit-form__time-input"},null,512),[[O,d.hours]]),t[5]||(t[5]=e("span",{class:"task-edit-form__time-suffix"},"ч",-1))]),e("div",Ze,[A(e("input",{"onUpdate:modelValue":t[2]||(t[2]=m=>d.minutes=m),type:"number",min:"0",max:"59",placeholder:"0",class:"task-edit-form__time-input"},null,512),[[O,d.minutes]]),t[6]||(t[6]=e("span",{class:"task-edit-form__time-suffix"},"мин",-1))]),e("div",et,[A(e("input",{"onUpdate:modelValue":t[3]||(t[3]=m=>d.seconds=m),type:"number",min:"0",max:"59",placeholder:"0",class:"task-edit-form__time-input"},null,512),[[O,d.seconds]]),t[7]||(t[7]=e("span",{class:"task-edit-form__time-suffix"},"сек",-1))])])]),e("div",tt,[_(D,{variant:"secondary",type:"button",onClick:t[4]||(t[4]=m=>o.$emit("cancel"))},{default:V(()=>[...t[10]||(t[10]=[C(" Отмена ",-1)])]),_:1}),_(D,{variant:"primary",type:"submit",loading:i.value},{default:V(()=>[...t[11]||(t[11]=[C(" Сохранить ",-1)])]),_:1},8,["loading"])])],32))}},st=M(at,[["__scopeId","data-v-0a87ed8d"]]);function ot(){const c=y([]),v=y(!1),s=y(null);async function a(r){v.value=!0,s.value=null;try{c.value=await fe(r)}catch(o){s.value="Не удалось загрузить задачи",console.error("Ошибка загрузки задач:",o)}finally{v.value=!1}}async function l(){v.value=!0,s.value=null;try{c.value=await pe()}catch(r){s.value="Не удалось загрузить задачи",console.error("Ошибка загрузки задач:",r)}finally{v.value=!1}}async function d(r,o){try{const t=await ee({projectId:r,name:o});return await a(r),t}catch(t){return s.value="Не удалось создать задачу",console.error("Ошибка создания задачи:",t),null}}async function w(r,o,t){try{await Z(r,o),t&&await a(t)}catch(m){s.value="Не удалось обновить задачу",console.error("Ошибка обновления задачи:",m)}}async function i(r,o,t){try{await Y(r,o),t&&await a(t)}catch(m){s.value="Не удалось обновить статус задачи",console.error("Ошибка обновления статуса:",m)}}async function g(r,o){try{await X(r),o&&await a(o)}catch(t){s.value="Не удалось удалить задачу",console.error("Ошибка удаления задачи:",t)}}async function b(r){try{return await ke(r)}catch(o){console.error("Ошибка получения задачи:",o);return}}return{tasks:c,isLoading:v,error:s,loadTasksByProject:a,loadAllTasks:l,addTask:d,editTask:w,toggleComplete:i,removeTask:g,getTask:b}}const nt={class:"project-detail"},lt={key:0,class:"project-detail__loading"},it={key:1,class:"project-detail__not-found"},rt={class:"project-detail__header"},dt={class:"project-detail__info"},ut={class:"project-detail__title"},ct={class:"project-detail__rate"},mt={class:"project-detail__actions"},vt={class:"project-detail__section"},kt={class:"project-detail__section"},pt={class:"project-detail__section"},ft={__name:"ProjectDetailView",setup(c){const v=_e(),s=ge(),a=Te(),{tasks:l,loadTasksByProject:d,addTask:w}=ot(),i=y(null),g=y(!0),b=y(!1),r=y(!1),o=y(null),t=y(!1),m=y(null),S=y(!1),T=y(Number(v.params.id));async function E(){g.value=!0;try{i.value=await G(T.value),i.value&&await d(T.value),await a.checkActiveTimer()}catch(u){console.error("Ошибка загрузки проекта:",u)}finally{g.value=!1}}K(()=>{E()}),x(()=>v.params.id,u=>{T.value=Number(u),E()});function I(){b.value=!0}async function P(u){await Ve(T.value,u),i.value=await G(T.value),b.value=!1}async function h(u){await w(T.value,u)}async function p(u){await a.start(u)}async function F(){await a.stop(),await d(T.value)}function se(u){o.value=u,r.value=!0}async function oe(u){if(o.value)try{await Z(o.value.id,{name:u.name}),u.additionalSeconds>0&&await be(o.value.id,u.additionalSeconds),await d(T.value),r.value=!1,o.value=null}catch(n){console.error("Ошибка обновления задачи:",n),alert("Ошибка при обновлении задачи")}}function ne(u){m.value=u,t.value=!0}async function le(){if(m.value)try{await X(m.value),await d(T.value)}catch(u){console.error("Ошибка удаления задачи:",u)}finally{m.value=null}}function ie(){S.value=!0}async function re(){try{await Se(T.value),s.push("/projects")}catch(u){console.error("Ошибка удаления проекта:",u)}}async function de(u){try{await Y(u,!0),await d(T.value)}catch(n){console.error("Ошибка завершения задачи:",n)}}async function ue(u){try{await ee({projectId:T.value,name:u.name,isRestored:!0}),await d(T.value)}catch(n){console.error("Ошибка восстановления задачи:",n)}}return(u,n)=>{const z=ye("router-link");return k(),f("div",nt,[_(z,{to:"/projects",class:"project-detail__back"},{default:V(()=>[...n[6]||(n[6]=[C(" ← Назад к проектам ",-1)])]),_:1}),g.value?(k(),f("div",lt," Загрузка проекта... ")):i.value?(k(),f(Q,{key:2},[e("header",rt,[e("div",dt,[e("div",{class:"project-detail__color",style:we({backgroundColor:i.value.color})},null,4),e("div",null,[e("h1",ut,R(i.value.name),1),e("p",ct," Ставка: "+R(j(ae)(i.value.hourlyRate))+"/час ",1)])]),e("div",mt,[_(D,{variant:"secondary",onClick:I},{default:V(()=>[...n[9]||(n[9]=[C(" Редактировать ",-1)])]),_:1}),_(D,{variant:"danger",onClick:ie},{default:V(()=>[...n[10]||(n[10]=[C(" Удалить ",-1)])]),_:1})])]),e("section",vt,[_(Ce,{"is-running":j(a).isRunning.value,"active-task":j(a).activeTask.value,"elapsed-seconds":j(a).elapsedSeconds.value,onStop:F},null,8,["is-running","active-task","elapsed-seconds"])]),e("section",kt,[n[11]||(n[11]=e("h2",{class:"project-detail__subtitle"},"Добавить задачу",-1)),_(Re,{onSubmit:h})]),e("section",pt,[n[12]||(n[12]=e("h2",{class:"project-detail__subtitle"},"Задачи",-1)),_(Qe,{tasks:j(l),"hourly-rate":i.value.hourlyRate,"active-task-id":j(a).activeTaskId.value,"is-timer-running":j(a).isRunning.value,"elapsed-seconds":j(a).elapsedSeconds.value,onStartTimer:p,onStopTimer:F,onEdit:se,onDelete:ne,onComplete:de,onRestore:ue},null,8,["tasks","hourly-rate","active-task-id","is-timer-running","elapsed-seconds"])])],64)):(k(),f("div",it,[n[8]||(n[8]=e("h2",null,"Проект не найден",-1)),_(z,{to:"/projects",class:"project-detail__link"},{default:V(()=>[...n[7]||(n[7]=[C(" Вернуться к списку проектов ",-1)])]),_:1})])),_(q,{modelValue:b.value,"onUpdate:modelValue":n[1]||(n[1]=$=>b.value=$),title:"Редактировать проект"},{default:V(()=>[_(he,{project:i.value,onSubmit:P,onCancel:n[0]||(n[0]=$=>b.value=!1)},null,8,["project"])]),_:1},8,["modelValue"]),_(q,{modelValue:r.value,"onUpdate:modelValue":n[3]||(n[3]=$=>r.value=$),title:"Редактировать задачу"},{default:V(()=>[o.value?(k(),W(st,{key:0,task:o.value,onSubmit:oe,onCancel:n[2]||(n[2]=$=>r.value=!1)},null,8,["task"])):B("",!0)]),_:1},8,["modelValue"]),_(H,{modelValue:t.value,"onUpdate:modelValue":n[4]||(n[4]=$=>t.value=$),title:"Удалить задачу?",message:"Задача будет перемещена в корзину. Вы сможете восстановить её позже.","confirm-text":"Удалить",onConfirm:le},null,8,["modelValue"]),_(H,{modelValue:S.value,"onUpdate:modelValue":n[5]||(n[5]=$=>S.value=$),title:"Удалить проект?",message:"Проект и все его задачи будут перемещены в корзину.","confirm-text":"Удалить проект",onConfirm:re},null,8,["modelValue"])])}}},ht=M(ft,[["__scopeId","data-v-eb9326b4"]]);export{ht as default};
