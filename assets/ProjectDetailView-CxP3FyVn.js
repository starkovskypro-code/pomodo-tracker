import{_ as E,e as T,b as _,o as p,a as e,i as w,w as V,m as h,z as J,f as N,g as K,A as me,h as R,B as ve,d as x,t as D,C as L,l as C,F as Q,p as pe,c as W,D as U,E as O,G as A,H as ke,I as X,J as Y,K as Z,L as ee,j as fe,v as _e,M as ye,n as we,y as Te,u as ge,s as be,N as he,O as Ce}from"./index-BUkxEhik.js";import{B as M}from"./BaseButton-DTPMeAVf.js";import{a as te,P as je,B as q}from"./ProjectForm-IT7VpTYN.js";import{C as H}from"./ConfirmDialog-RS1OHfPS.js";import{T as $e}from"./Timer-ZiVtQpXt.js";import{c as Ve,f as Se,a as ae,b as G,u as Be,d as xe}from"./projectRepository-Bp8vvTf4.js";const Re={class:"task-form__row"},De={__name:"TaskForm",emits:["submit"],setup(d,{emit:c}){const o=c,a=T(""),s=T("");function u(){s.value="";const k=a.value.trim();if(!k){s.value="Введите название задачи";return}o("submit",k),a.value=""}return(k,m)=>(p(),_("form",{class:"task-form",onSubmit:J(u,["prevent"])},[e("div",Re,[w(te,{modelValue:a.value,"onUpdate:modelValue":m[0]||(m[0]=y=>a.value=y),placeholder:"Новая задача...",error:s.value},null,8,["modelValue","error"]),w(M,{variant:"primary",type:"submit",disabled:!a.value.trim()},{default:V(()=>[...m[1]||(m[1]=[h(" Добавить ",-1)])]),_:1},8,["disabled"])])],32))}},Me=E(De,[["__scopeId","data-v-bb968898"]]),Ee={class:"task-card__left"},Ie={key:0,class:"task-card__restored-badge",title:"Восстановленная задача"},Pe={class:"task-card__name"},Ne={class:"task-card__right"},Le={class:"task-card__stats"},Ue={class:"task-card__cost"},Oe={class:"task-card__menu-wrapper"},Ae={key:0,class:"task-card__dropdown"},Fe=["aria-label","disabled"],ze={key:0,width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor"},qe={key:1,width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor"},He={__name:"TaskCard",props:{task:{type:Object,required:!0},hourlyRate:{type:Number,default:0},activeTaskId:{type:Number,default:null},isTimerRunning:{type:Boolean,default:!1},elapsedSeconds:{type:Number,default:0}},emits:["start-timer","stop-timer","edit","delete","complete","restore"],setup(d,{expose:c,emit:o}){const a=d,s=o,u=T(!1),k=T(0),m=N(()=>a.activeTaskId===a.task.id),y=N(()=>m.value&&a.isTimerRunning?k.value+a.elapsedSeconds:k.value),j=N(()=>Ve(y.value,a.hourlyRate));K(async()=>{await i(),document.addEventListener("click",v)}),me(()=>{document.removeEventListener("click",v)}),R(()=>a.task.id,async()=>{await i()}),R(()=>a.isTimerRunning,async(b,f)=>{f===!0&&b===!1&&await i()}),R(()=>a.activeTaskId,async(b,f)=>{f===a.task.id&&b!==a.task.id&&await i()});async function i(){try{k.value=await ve(a.task.id)}catch(b){console.error("Ошибка загрузки времени задачи:",b)}}function l(b){b.stopPropagation(),u.value=!u.value}function t(){u.value=!1}function v(b){u.value&&t()}function S(){m.value?s("stop-timer"):s("start-timer",a.task.id)}function B(){t(),s("edit",a.task)}function g(){t(),s("complete",a.task.id)}function I(){t(),s("restore",a.task)}function P(){t(),s("delete",a.task.id)}return c({loadTime:i}),(b,f)=>(p(),_("div",{class:L(["task-card",{"task-card--completed":d.task.completed,"task-card--active":m.value}])},[e("div",Ee,[d.task.isRestored?(p(),_("span",Ie," ↩ ")):x("",!0),e("span",Pe,D(d.task.name),1)]),e("div",Ne,[e("div",Le,[e("span",{class:L(["task-card__time",{"task-card__time--active":m.value}])},D(C(Se)(y.value)),3),e("span",Ue,D(C(ae)(j.value)),1)]),e("div",Oe,[e("button",{class:"task-card__menu-btn",onClick:l,"aria-label":"Меню действий"},[...f[0]||(f[0]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor"},[e("circle",{cx:"12",cy:"5",r:"2"}),e("circle",{cx:"12",cy:"12",r:"2"}),e("circle",{cx:"12",cy:"19",r:"2"})],-1)])]),u.value?(p(),_("div",Ae,[e("button",{class:"task-card__dropdown-item",onClick:B},[...f[1]||(f[1]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),e("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})],-1),h(" Редактировать ",-1)])]),d.task.completed?(p(),_("button",{key:1,class:"task-card__dropdown-item",onClick:I},[...f[3]||(f[3]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("polyline",{points:"1,4 1,10 7,10"}),e("path",{d:"M3.51 15a9 9 0 1 0 2.13-9.36L1 10"})],-1),h(" Восстановить ",-1)])])):(p(),_("button",{key:0,class:"task-card__dropdown-item",onClick:g},[...f[2]||(f[2]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("polyline",{points:"20,6 9,17 4,12"})],-1),h(" Завершить ",-1)])])),e("button",{class:"task-card__dropdown-item task-card__dropdown-item--danger",onClick:P},[...f[4]||(f[4]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("polyline",{points:"3,6 5,6 21,6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})],-1),h(" Удалить ",-1)])])])):x("",!0)]),d.task.completed?x("",!0):(p(),_("button",{key:0,class:L(["task-card__timer-btn",{"task-card__timer-btn--active":m.value}]),onClick:S,"aria-label":m.value?"Остановить таймер":"Запустить таймер",disabled:d.isTimerRunning&&!m.value},[m.value?(p(),_("svg",ze,[...f[5]||(f[5]=[e("rect",{x:"6",y:"6",width:"12",height:"12",rx:"2"},null,-1)])])):(p(),_("svg",qe,[...f[6]||(f[6]=[e("polygon",{points:"5,3 19,12 5,21"},null,-1)])]))],10,Fe))]),u.value?(p(),_("div",{key:0,class:"task-card__overlay",onClick:t})):x("",!0)],2))}},Ge=E(He,[["__scopeId","data-v-019568c9"]]),Je={class:"task-list"},Ke={key:0,class:"task-list__empty"},Qe={key:1,class:"task-list__items"},We={__name:"TaskList",props:{tasks:{type:Array,required:!0},hourlyRate:{type:Number,default:0},activeTaskId:{type:Number,default:null},isTimerRunning:{type:Boolean,default:!1},elapsedSeconds:{type:Number,default:0}},emits:["start-timer","stop-timer","edit","delete","complete","restore"],setup(d){return(c,o)=>(p(),_("div",Je,[d.tasks.length===0?(p(),_("div",Ke,[...o[6]||(o[6]=[e("p",null,"Пока нет задач",-1),e("p",{class:"task-list__empty-hint"},"Добавьте первую задачу выше",-1)])])):(p(),_("div",Qe,[(p(!0),_(Q,null,pe(d.tasks,a=>(p(),W(Ge,{key:a.id,task:a,"hourly-rate":d.hourlyRate,"active-task-id":d.activeTaskId,"is-timer-running":d.isTimerRunning,"elapsed-seconds":d.elapsedSeconds,onStartTimer:o[0]||(o[0]=s=>c.$emit("start-timer",s)),onStopTimer:o[1]||(o[1]=s=>c.$emit("stop-timer")),onEdit:o[2]||(o[2]=s=>c.$emit("edit",s)),onDelete:o[3]||(o[3]=s=>c.$emit("delete",s)),onComplete:o[4]||(o[4]=s=>c.$emit("complete",s)),onRestore:o[5]||(o[5]=s=>c.$emit("restore",s))},null,8,["task","hourly-rate","active-task-id","is-timer-running","elapsed-seconds"]))),128))]))]))}},Xe=E(We,[["__scopeId","data-v-8bdf9431"]]),Ye={class:"task-edit-form__time-section"},Ze={class:"task-edit-form__time-inputs"},et={class:"task-edit-form__time-field"},tt={class:"task-edit-form__time-field"},at={class:"task-edit-form__time-field"},st={class:"task-edit-form__actions"},ot={__name:"TaskEditForm",props:{task:{type:Object,required:!0}},emits:["submit","cancel"],setup(d,{emit:c}){const o=d,a=c,s=U({name:""}),u=U({hours:"",minutes:"",seconds:""}),k=U({name:""}),m=T(!1);R(()=>o.task,l=>{l&&(s.name=l.name||"")},{immediate:!0});function y(){let l=!0;return k.name="",s.name.trim()||(k.name="Укажите название задачи",l=!1),l}function j(){const l=parseInt(u.hours)||0,t=parseInt(u.minutes)||0,v=parseInt(u.seconds)||0;return l*3600+t*60+v}async function i(){y()&&(m.value=!0,a("submit",{name:s.name.trim(),additionalSeconds:j()}),m.value=!1)}return(l,t)=>(p(),_("form",{class:"task-edit-form",onSubmit:J(i,["prevent"])},[w(te,{modelValue:s.name,"onUpdate:modelValue":t[0]||(t[0]=v=>s.name=v),label:"Название задачи",placeholder:"Название...",error:k.name},null,8,["modelValue","error"]),e("div",Ye,[t[8]||(t[8]=e("label",{class:"task-edit-form__label"},"Добавить время вручную",-1)),t[9]||(t[9]=e("p",{class:"task-edit-form__hint"}," Укажите часы, минуты и секунды, которые нужно добавить ",-1)),e("div",Ze,[e("div",et,[O(e("input",{"onUpdate:modelValue":t[1]||(t[1]=v=>u.hours=v),type:"number",min:"0",placeholder:"0",class:"task-edit-form__time-input"},null,512),[[A,u.hours]]),t[5]||(t[5]=e("span",{class:"task-edit-form__time-suffix"},"ч",-1))]),e("div",tt,[O(e("input",{"onUpdate:modelValue":t[2]||(t[2]=v=>u.minutes=v),type:"number",min:"0",max:"59",placeholder:"0",class:"task-edit-form__time-input"},null,512),[[A,u.minutes]]),t[6]||(t[6]=e("span",{class:"task-edit-form__time-suffix"},"мин",-1))]),e("div",at,[O(e("input",{"onUpdate:modelValue":t[3]||(t[3]=v=>u.seconds=v),type:"number",min:"0",max:"59",placeholder:"0",class:"task-edit-form__time-input"},null,512),[[A,u.seconds]]),t[7]||(t[7]=e("span",{class:"task-edit-form__time-suffix"},"сек",-1))])])]),e("div",st,[w(M,{variant:"secondary",type:"button",onClick:t[4]||(t[4]=v=>l.$emit("cancel"))},{default:V(()=>[...t[10]||(t[10]=[h(" Отмена ",-1)])]),_:1}),w(M,{variant:"primary",type:"submit",loading:m.value},{default:V(()=>[...t[11]||(t[11]=[h(" Сохранить ",-1)])]),_:1},8,["loading"])])],32))}},nt=E(ot,[["__scopeId","data-v-0a87ed8d"]]);function lt(){const d=T([]),c=T(!1),o=T(null);async function a(i){c.value=!0,o.value=null;try{d.value=await _e(i)}catch(l){o.value="Не удалось загрузить задачи",console.error("Ошибка загрузки задач:",l)}finally{c.value=!1}}async function s(){c.value=!0,o.value=null;try{d.value=await fe()}catch(i){o.value="Не удалось загрузить задачи",console.error("Ошибка загрузки задач:",i)}finally{c.value=!1}}async function u(i,l){try{const t=await ee({projectId:i,name:l});return await a(i),t}catch(t){return o.value="Не удалось создать задачу",console.error("Ошибка создания задачи:",t),null}}async function k(i,l,t){try{await Z(i,l),t&&await a(t)}catch(v){o.value="Не удалось обновить задачу",console.error("Ошибка обновления задачи:",v)}}async function m(i,l,t){try{await Y(i,l),t&&await a(t)}catch(v){o.value="Не удалось обновить статус задачи",console.error("Ошибка обновления статуса:",v)}}async function y(i,l){try{await X(i),l&&await a(l)}catch(t){o.value="Не удалось удалить задачу",console.error("Ошибка удаления задачи:",t)}}async function j(i){try{return await ke(i)}catch(l){console.error("Ошибка получения задачи:",l);return}}return{tasks:d,isLoading:c,error:o,loadTasksByProject:a,loadAllTasks:s,addTask:u,editTask:k,toggleComplete:m,removeTask:y,getTask:j}}const it={class:"project-detail"},rt={key:0,class:"project-detail__loading"},dt={key:1,class:"project-detail__not-found"},ut={class:"project-detail__header"},ct={class:"project-detail__info"},mt={class:"project-detail__title"},vt={class:"project-detail__rate"},pt={class:"project-detail__actions"},kt={class:"project-detail__section"},ft={class:"project-detail__section"},_t={class:"project-detail__section"},yt={__name:"ProjectDetailView",setup(d){const c=ye(),o=be(),a=ge(),s=Ce(),{tasks:u,loadTasksByProject:k,addTask:m}=lt(),y=T(null),j=T(!0),i=T(!1),l=T(!1),t=T(null),v=T(!1),S=T(null),B=T(!1),g=T(Number(c.params.id));async function I(){j.value=!0;try{y.value=await G(g.value),y.value&&await k(g.value),await a.checkActiveTimer()}catch(r){console.error("Ошибка загрузки проекта:",r)}finally{j.value=!1}}K(()=>{I()}),R(()=>c.params.id,r=>{g.value=Number(r),I()});function P(){i.value=!0}async function b(r){await Be(g.value,r),y.value=await G(g.value),i.value=!1}async function f(r){await m(g.value,r)}async function se(r){await a.start(r),s.mode.value==="idle"&&s.start("work",!0)}async function F(){await a.stop(),s.stop(),await k(g.value)}function oe(r){t.value=r,l.value=!0}async function ne(r){if(t.value)try{await Z(t.value.id,{name:r.name}),r.additionalSeconds>0&&await he(t.value.id,r.additionalSeconds),await k(g.value),l.value=!1,t.value=null}catch(n){console.error("Ошибка обновления задачи:",n),alert("Ошибка при обновлении задачи")}}function le(r){S.value=r,v.value=!0}async function ie(){if(S.value)try{await X(S.value),await k(g.value)}catch(r){console.error("Ошибка удаления задачи:",r)}finally{S.value=null}}function re(){B.value=!0}async function de(){try{await xe(g.value),o.push("/projects")}catch(r){console.error("Ошибка удаления проекта:",r)}}async function ue(r){try{await Y(r,!0),await k(g.value)}catch(n){console.error("Ошибка завершения задачи:",n)}}async function ce(r){try{await ee({projectId:g.value,name:r.name,isRestored:!0}),await k(g.value)}catch(n){console.error("Ошибка восстановления задачи:",n)}}return(r,n)=>{const z=we("router-link");return p(),_("div",it,[w(z,{to:"/projects",class:"project-detail__back"},{default:V(()=>[...n[6]||(n[6]=[h(" ← Назад к проектам ",-1)])]),_:1}),j.value?(p(),_("div",rt," Загрузка проекта... ")):y.value?(p(),_(Q,{key:2},[e("header",ut,[e("div",ct,[e("div",{class:"project-detail__color",style:Te({backgroundColor:y.value.color})},null,4),e("div",null,[e("h1",mt,D(y.value.name),1),e("p",vt," Ставка: "+D(C(ae)(y.value.hourlyRate))+"/час ",1)])]),e("div",pt,[w(M,{variant:"secondary",onClick:P},{default:V(()=>[...n[9]||(n[9]=[h(" Редактировать ",-1)])]),_:1}),w(M,{variant:"danger",onClick:re},{default:V(()=>[...n[10]||(n[10]=[h(" Удалить ",-1)])]),_:1})])]),e("section",kt,[w($e,{"is-running":C(a).isRunning.value,"active-task":C(a).activeTask.value,"elapsed-seconds":C(a).elapsedSeconds.value,onStop:F},null,8,["is-running","active-task","elapsed-seconds"])]),e("section",ft,[n[11]||(n[11]=e("h2",{class:"project-detail__subtitle"},"Добавить задачу",-1)),w(Me,{onSubmit:f})]),e("section",_t,[n[12]||(n[12]=e("h2",{class:"project-detail__subtitle"},"Задачи",-1)),w(Xe,{tasks:C(u),"hourly-rate":y.value.hourlyRate,"active-task-id":C(a).activeTaskId.value,"is-timer-running":C(a).isRunning.value,"elapsed-seconds":C(a).elapsedSeconds.value,onStartTimer:se,onStopTimer:F,onEdit:oe,onDelete:le,onComplete:ue,onRestore:ce},null,8,["tasks","hourly-rate","active-task-id","is-timer-running","elapsed-seconds"])])],64)):(p(),_("div",dt,[n[8]||(n[8]=e("h2",null,"Проект не найден",-1)),w(z,{to:"/projects",class:"project-detail__link"},{default:V(()=>[...n[7]||(n[7]=[h(" Вернуться к списку проектов ",-1)])]),_:1})])),w(q,{modelValue:i.value,"onUpdate:modelValue":n[1]||(n[1]=$=>i.value=$),title:"Редактировать проект"},{default:V(()=>[w(je,{project:y.value,onSubmit:b,onCancel:n[0]||(n[0]=$=>i.value=!1)},null,8,["project"])]),_:1},8,["modelValue"]),w(q,{modelValue:l.value,"onUpdate:modelValue":n[3]||(n[3]=$=>l.value=$),title:"Редактировать задачу"},{default:V(()=>[t.value?(p(),W(nt,{key:0,task:t.value,onSubmit:ne,onCancel:n[2]||(n[2]=$=>l.value=!1)},null,8,["task"])):x("",!0)]),_:1},8,["modelValue"]),w(H,{modelValue:v.value,"onUpdate:modelValue":n[4]||(n[4]=$=>v.value=$),title:"Удалить задачу?",message:"Задача будет перемещена в корзину. Вы сможете восстановить её позже.","confirm-text":"Удалить",onConfirm:ie},null,8,["modelValue"]),w(H,{modelValue:B.value,"onUpdate:modelValue":n[5]||(n[5]=$=>B.value=$),title:"Удалить проект?",message:"Проект и все его задачи будут перемещены в корзину.","confirm-text":"Удалить проект",onConfirm:de},null,8,["modelValue"])])}}},jt=E(yt,[["__scopeId","data-v-f96b205f"]]);export{jt as default};
